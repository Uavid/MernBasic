# ================================
# Backend Deployment
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: local-backend:latest
          ports:
            - containerPort: 7000

---
# Backend Service
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
spec:
  selector:
    app: backend
  ports:
    - port: 7000
      targetPort: 7000
  type: ClusterIP

# ================================
# Frontend Deployment (NGINX)
# ================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: local-frontend:latest
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-config

---
# Frontend Service (LoadBalancer / NodePort)
apiVersion: v1
kind: Service
metadata:
  name: frontend-svc
spec:
  type: NodePort   # If using cloud, change to LoadBalancer
  selector:
    app: frontend
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30100   # Access via http://<node-ip>:30100

# ================================
# NGINX ConfigMap
# ================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  default.conf: |
    server {
      listen 80;
      server_name _;

      root /usr/share/nginx/html;
      index index.html;

      # Serve static assets
      location ~* \.(js|css|json|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        try_files $uri =404;
        access_log off;
        expires 1y;
      }

      # Proxy API to backend
      location /api/ {
        proxy_pass http://backend-svc:7000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
      }

      # React Router Fallback
      location / {
        try_files $uri /index.html;
      }
    }
